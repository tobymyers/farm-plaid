<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm App</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet Control Geocoder JavaScript -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- Leaflet Draw JavaScript -->
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

    <style>
        /* Add the styles from your provided CSS file here */

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            background-color: #333;
            color: #fff;
            padding: 10px;
        }

        h3 {
            text-align: center;
            background-color: #ffffff;
            color: #333;
            padding: 10px;
        }

        main {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        #container {
            display: flex;
            width: 100%;
        }

        #map {
            flex: 1;
            min-height: 400px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        #form-container {
            width: 30%; /* Adjusted width as needed */
            min-height: 400px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 10px;
            margin-bottom: 4px;
        }

        input,
        select {
            padding: 8px;
            margin-bottom: 16px;
        }

        button {
            background-color: #333;
            color: #fff;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>

<h1>FieldShare</h1>
<h3>Get paid to log your field data in one place, never have to log it in another app again</h3>

<!-- Container for map and form -->
<div id="container">
    <!-- Your existing map container -->
    <div id="map"></div>

    <!-- Form for adding data about the polygon -->
    <div id="form-container">
        <form id="fieldForm">
            <button type="button" onclick="locateUser()">Select My Current Location</button>
            <label for="polygonName">Field Name:</label>
            <input type="text" id="polygonName" name="polygonName" required>

            <label for="area">Area (square meters):</label>
            <input type="text" id="area" name="area" readonly>

            <!-- New field for displaying coordinates -->
            <label for="cropSelection">Current Crop:</label>
            <select id="cropSelection" name="crop">
                <option value="corn">Corn</option>
                <option value="wheat">Wheat</option>
                <option value="potatoes">Potatoes</option>
                <option value="apples">Apples</option>
                <option value="other">Other</option>
            </select>

            <label for="plantDate">Plant Date:</label>
            <input type="date" id="plantDate" name="plantDate">

            <label for="harvestDate">Expected Harvest Date:</label>
            <input type="date" id="harvestDate" name="harvestDate">

            <button type="button" onclick="saveField()">Save Field</button>
        </form>
    </div>
</div>

<!-- Flash messages section -->
{% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul class="flash-messages">
        {% for message in messages %}
        <li class="flash-message">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
{% endwith %}

<script>
    function saveField() {
        var fieldName = document.getElementById("polygonName").value;
        var locationData = document.getElementById("additionalData").value;
        var currentCrop = document.getElementById("cropSelection").value;
        var plantDate = document.getElementById("plantDate").value;
        var harvestDate = document.getElementById("harvestDate").value;

        // Prepare data object
        var data = {
            fieldName: fieldName,
            locationData: locationData,
            currentCrop: currentCrop,
            plantDate: plantDate,
            harvestDate: harvestDate
        };

        console.log('Data before sending:', data);

        // Make a POST request with JSON data
        fetch('http://127.0.0.1:8000/save-field', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Reload the page to see flash messages
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>

<script>
    // Initialize the map
    var map = L.map('map').setView([0, 0], 2);

    // Add a tile layer ( satellite layer )
    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© Esri'
    });

    satelliteLayer.addTo(map); // Add the satellite layer to the map

    // Initialize geocoding control with auto-complete
    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        collapsed: true,
        geocoder: L.Control.Geocoder.nominatim({ geocodingQueryParams: { language: 'en', limit: 5 } }),
        autoComplete: true, // Enable auto-complete
        autoCompleteDelay: 250, // Set the delay for auto-complete
        autoCollapse: true // Collapse the control after selecting a result
    }).on('markgeocode', function (e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest(),
        ]).addTo(map);
        map.fitBounds(poly.getBounds());
    }).addTo(map);

    // Add the Leaflet Draw control
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        draw: {
            polygon: true,
            circle: false,
            marker: false, // Disable marker drawing
            polyline: false, // Disable polyline drawing
            rectangle: false // Disable rectangle drawing
        },
        edit: {
            featureGroup: drawnItems,
            remove: true
        }
    });

    map.addControl(drawControl);

    map.on('draw:created', function (event) {
        var layer = event.layer;
        drawnItems.addLayer(layer);

        // Update the area field with the area of the drawn shape
        var areaField = document.getElementById("area");

        // Reverse the order of coordinates and convert them to an array
        var coordinates = layer.getLatLngs()[0].map(function (latLng) {
            return [latLng.lng, latLng.lat];
        });

        var area = L.GeometryUtil.geodesicArea(coordinates);
        areaField.value = area.toFixed(2) + " square meters";

        // Update the coordinates field with the coordinates of the drawn shape
        var coordinatesField = document.getElementById("coordinates");
        coordinatesField.value = JSON.stringify(coordinates);
    });



    // Function to submit the polygon data
    function submitPolygon() {
        // Retrieve data from the form
        var polygonName = document.getElementById("polygonName").value;
        var additionalData = document.getElementById("additionalData").value;

        // You can access the coordinates of the drawn polygon from 'drawnItems' feature group
        var polygonCoordinates = drawnItems.toGeoJSON().features[0].geometry.coordinates;

        // Prepare data object
        var data = {
            name: polygonName,
            additionalData: additionalData,
            coordinates: polygonCoordinates
        };
        console.log('Data before sending:', data);

        // Make a POST request with JSON data (you'll need to handle this in your Flask app)
        fetch('http://127.0.0.1:8000/submit-polygon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Reload the page or update the UI as needed
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // locate user button
    function locateUser() {
        map.locate({ setView: true, maxZoom: 16 });
    }
</script>
</body>
</html>